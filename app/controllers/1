class ApplicationController < ActionController::Base

    helper :all

    def saveEntry(params)
        puts "ApplicationController.saveEntry called. params=#{params}"
        templateId = params[:template_id];
        template = Template.find(templateId)
        fields = template.fields
            
        #title = "#{template.name} Entry"
        title = getEntryTitle(template, fields, params[:fields])
                   
        cachedHtml = params[:html];
        
        if (params.has_key?(:entry_id) && params[:entry_id] != '0') 
            @entry = Entry.find(params[:entry_id])
            if params.has_key?(:title) 
                @entry.title = params[:title]
            end
        else                    
            @entry = Entry.new(
                :template => template,
                :title => title,
                :entry_type => "templated",
                :body => cachedHtml,
                :refresh_html => true,
                :creator => 1,
                :status => "ACTIVE",
            )
        end

        @entry.save

        fieldsData = params[:fields]
        
        fieldValues = Array.new
        fieldsData.each do |fieldId,fieldData|

            saveFieldValue(@entry.id, fieldId, fieldData)
            
        end

                
        @entry.save
       
        if params.has_key?(:p_entry_id)
            addAssociatedEntry(params[:p_entry_id], @entry.id)
        end
       

       return @entry
    end





    def saveFieldValue(entryId, fieldId, fieldData)
       puts "In saveFieldValue"
       field = Field.find(fieldId)
       entry = Entry.find(entryId)
        
       if field.fieldtype == 't_list'
        fieldValue = FieldValue.where({:entry_id=>entryId, :field_id=>fieldId})
        if fieldValue==nil
            fieldValue = FieldValue.new(:field_id=>fieldId, :value=>'')
            fieldValue.save
        end
        #save the templated Data


       else

           fieldValue = entry.fieldValues.where({:field_id=>fieldId})
            puts "fieldId=#{fieldId}, fieldValue=#{fieldValue}" 

           if fieldValue.first == nil
                fieldValue = FieldValue.new({:field_id=>fieldId,:entry_id=>entryId,:value=>fieldData[:value]})

                if fieldData[:metadata] != nil
                    fieldData[:metadata].each do |mdKey,mdValue|
                    fieldValue.field_metadata.push(FieldMetadata.new({:key=>mdKey, :value=>mdValue}))
               end
            end
            fieldValue.save

           else 
            
                fieldValue.update_all(:value => fieldData[:value])

          end
       end
       


    end

    def getEntryTitle(template, fields, fieldValues)
        title = "[#{template.name}]"
        titleValue = ""

        fields.each do |field|
            if field.label.upcase == 'NAME' || field.label.upcase == 'TITLE'
                puts "title field.id=#{field.id}"
                key = "'#{field.id}'"
                titleValue = fieldValues[field.id.to_s]['value']
                break
            end
        end
        title = "#{title} #{titleValue}"
        return title

    end

    def getTemplateHtml(templateId, params)
      puts "In ApplicationController.getTemplateHtml, templateId=#{templateId}"
      @template = Template.find(templateId)
      fields = @template.fields.includes(:list_descriptor)

      @fieldValues = Hash.new
      @mode = 'new'      
      templateHtml = render_to_string(:template=>"templates/table_format.html.erb", 
                                      :layout=>false,
                                      :params=>params)
      
      return templateHtml

    end

    def paramsToUrl(params)
        elems = []
        params.each do |key,value|
            if key != 'controller' && key != 'action'
                elems << "#{key}=#{value}"
            end
        end
        return elems.join('&')
    end
    
    def getEntryHtml(params)
        entryId = params[:entry_id] 
        @entry = Entry.find(entryId)
        viewType = params['view_type']
        mode = params[:mode]
        
        context = params

        if @entry.entry_type == 'list'
            listDescriptor = JSON.parse(@entry.descriptor)
            @entries = getListEntries(listDescriptor)
            
            if params.has_key?('view_type')
                viewType = params['view_type']
            else
                viewType = 'list_title'
            end
                
            entryHtml = render_to_string(
                :template => "/entries/#{listDescriptor['item_class']}_#{viewType}.html.erb",
                :layout => false, 
                :context => context
            )
        end

            
               

        if @entry.entry_type == 'templated'
            @context = params
            @fields = @entry.template.fields
            @fieldValues = @entry.fieldValues.includes(:field, :field_metadata)
            @template = @entry.template            
            @mode = mode
             
             
            @context[:params_url] = paramsToUrl(@context)
            puts "@context[:params_url] =  #{@context[:params_url]}"
            
            fieldValues.each do |fieldValue| 
                if fieldValue.field[:fieldtype] == '_t_association_list'
                  associatedTemplateId = fieldValue.field.list_descriptor[:item_type_id]
                  associatedEntries = getAssociatedEntries(@entry.id, associatedTemplateId)
                  fieldValue[:html] = getListHtml(associatedEntries)
                end
            end
         
            if context.has_key?(:view_type)
                    template = "/entries/#{@context[:view_type]}_format.html.erb"
    
            else
                template = "/entries/table_format.html.erb"
            end

            entryHtml = render_to_string( 
                      :template => template,
                      :layout => false
                      )

        end

        return entryHtml
    end


    def getListHtml(entries)
        params = {:view_type=>"list_full"}
        html = ""
        entries.each do |entry| 
            html = html + getEntryHtml(entry)
        end
        return html
    end

    def getListEntries(params)
        if params['item_class'] == 'entry'
            templateId = params['item_type_id']
            entries = Entry.where(:template_id=>templateId)
        end
        return entries

    end

    def addAssociatedEntry(entryId, associatedEntryId)
       puts "In addAssociatedEntry: entryId=#{entryId}, associatedEntryId=#{associatedEntryId}" 
       a = EntryAssociation.new(attributes={:entry_id=>entryId, :associated_entry_id=>associatedEntryId})
       a.save
    end

    def getAssociatedEntries(entryId,associatedEntryTemplateId)
       entries = Entry.find(entryId).associated_entries.where(:template_id=>associatedEntryTemplateId)
       return entries
=begin
       entries = Hash.new
       

       allAssociatedEntries = Entry.find(entryId).associated_entries

       allAssociatedEntries.each do |associatedEntry|
         if associatedEntry.template_id == associatedEntryTemplateId
             entries[associatedEntry.id] = associatedEntry
         end
       end
       return entries
=end    
    end





  def getBlockHtml(blockId, params)
      @block = Block.find(blockId)
      mode = params[:mode]
      if params.has_key?(:mode) == false || mode == 'edit' || mode == 'display'
          @mainEntryId = params[:main_entry_id]
      else
          @mainEntryId = 0
      end
      
      params[:saveUrl] = "/blocks/handle?instruction=save&block_id=#{@block.id}&template_id=#{@block.template.id}&main_entry_id=#{@mainEntryId}"

      params[:saveButtonClass] = "block-save-entry-button save_button"
      
      blockTemplate = "blocks/configured/#{@block.entry_type}_#{@block.view_type}.html.erb"
      
      editorHtml = ""
      if @block.view_type == 'main' && params[:mode] == 'display'
            editorHtml = getEntryHtml(@mainEntryId, params)
      else
            editorHtml = getTemplateHtml(@block.template.id, params)
      end
      params[:editorHtml] = editorHtml

      params[:entries] = getBlockEntries(@block, params)

      blockHtml = render_to_string(:template=>blockTemplate, :layout=>false, :params=>params)
      return blockHtml

  end

  def getBlockEntries(block, params)
    entries = Array.new
    if params.has_key?(:main_entry_id) == false
        return entries
    end

    mainEntryId = params[:main_entry_id]

    if block.view_type == 'main'
        entry = Entry.find(mainEntryId)
        entries.push(entry)
    end

    if block.view_type == 'association_list'
        entries = getAssociatedEntries(mainEntryId, block.template.id)
    end
    
    return entries

  end

end

